<!DOCTYPE html>
<html>
<head>          
    <meta charset="utf-8" />
    <title>Monitor Vendite</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: Arial;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Sezioni verticali */
        .section-title {
            flex: 0 0 8%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-table {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-buttons {
            flex: 0 0 8%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        /* Contenitore scrollabile */
        .scroll-box {
            flex: 1;
            width: 95%;
            margin: auto;
            overflow-y: auto;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 10px;
        }

        /* Pulsanti */
        .btn {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }

        .btn-add { background-color: #28a745; }
        .btn-del { background-color: #dc3545; }

        /* Tabella */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 18px;
        }

        th, td {
            border: 1px solid #444;
            padding: 10px 20px;
        }

        th {
            background-color: #eee;
        }

        /* Nascondo la colonna ID */
        td:nth-child(1), th:nth-child(1) {
            display: none;
        }

        /* Riga selezionata */
        tr.selezionata {
            background-color: #ffe08a;
        }

        /* Colonna immagini grande come nellâ€™altra tabella */
        td:nth-last-child,
        th:nth-last-child {
            max-height: 5px;
            width: 150px;
        }

        /* Immagini grandi e proporzionate */
        td:nth-last-child img {
            height: 100%;
            width: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        td { 
            height: 40px; /* o 30px, o 25px */ 
        }

        img { 
            max-width: 200px; 
        }

        /* Centra il testo nella colonna Prezzo */
        td:nth-child(3),
        th:nth-child(3),
        td:nth-child(4),
        th:nth-child(4) {
            text-align: center;
        }

    </style>
</head>

<body>

    <!-- SEZIONE TITOLO -->
    <div class="section-title">
        <h1>Tabella Vendite</h1>
    </div>

    <!-- SEZIONE TABELLA -->
    <div class="section-table">
        <div class="scroll-box">
            <div id="tabella"></div>
        </div>
    </div>

    <!-- SEZIONE PULSANTI -->
    <div class="section-buttons">
        <button class="btn btn-add" onclick="vaiAggiungi()">AGGIUNGI</button>
        <button class="btn btn-del" onclick="eliminaRiga()">ELIMINA</button>
    </div>

    <script>
        const client = supabase.createClient(
            "https://ixarnqyrsonhshkctcki.supabase.co",
            "sb_publishable_pGINBChZ1U3J4xUEvb0XtQ_pR7wc9eZ"
        );

        let rigaSelezionata = null;

        async function caricaTabella() {
            const { data: vendite } =
                await client.from("vendite").select("*").order("id", { ascending: true });

            const { data: colorazioni } =
                await client.from("colorazioni").select("*");

            if (!vendite || !colorazioni) {
                document.getElementById("tabella").innerHTML = "<p>Errore nel caricamento</p>";
                return;
            }

            const mappaColorazioni = {};
            for (const c of colorazioni) {
                if (!mappaColorazioni[c.id]) mappaColorazioni[c.id] = [];
                mappaColorazioni[c.id].push(c.percorsoimmagine);
            }

            document.getElementById("tabella").innerHTML =
                generaHTMLTabella(vendite, mappaColorazioni);
        }

        function generaHTMLTabella(dati, mappaColorazioni) {
            if (!dati.length) return "<p>Nessun dato trovato.</p>";

            const colonne = Object.keys(dati[0]).filter(c => c !== "prodottoid");

            let html = "<table><tr>";
            for (const col of colonne) html += `<th>${col}</th>`;
            html += `<th>Immagine</th></tr>`;

            for (const riga of dati) {
                html += `<tr onclick="selezionaRiga(this)">`;

                for (const col of colonne) {
                    if (col.toLowerCase() === "immagine") {
                        html += `<td><img src="${riga[col]}"></td>`;
                    } else if (col.toLowerCase() === "data") {
                        const soloData = new Date(riga[col]).toLocaleDateString("it-IT");
                        html += `<td>${soloData}</td>`;
                    } else {
                        html += `<td>${riga[col]}</td>`;
                    }
                }

                const imgs = mappaColorazioni[riga.colorazioneid] || [];
                html += `<td>${imgs.map(src => `<img src="${src}">`).join(" ")}</td>`;

                html += "</tr>";
            }

            html += "</table>";
            return html;
        }

        function selezionaRiga(tr) {
            document.querySelectorAll("tr").forEach(r => r.classList.remove("selezionata"));
            tr.classList.add("selezionata");

            const id = tr.querySelector("td").innerText;
            rigaSelezionata = id;
        }

        async function eliminaRiga() {
            if (!rigaSelezionata) {
                alert("Seleziona una riga prima di eliminare.");
                return;
            }

            const { error } = await client
                .from("vendite")
                .delete()
                .eq("id", rigaSelezionata);

            if (error) {
                alert("Errore durante l'eliminazione.");
                return;
            }

            alert("Riga eliminata.");
            rigaSelezionata = null;
            caricaTabella();
        }

        function vaiAggiungi() {
            window.location.href = "page_aggiungi_vendita.html";
        }

        window.onload = caricaTabella;
    </script>

</body>
</html>
