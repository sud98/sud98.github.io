<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Aggiungi Vendita</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Layout verticale */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .section-title { flex: 0 0 5%; display: flex; align-items: center; justify-content: center; }
        .section-prodotti { flex: 0 0 45%; overflow: hidden; display: flex; flex-direction: column; }
        .section-carrello-title { flex: 0 0 5%; display: flex; align-items: center; justify-content: center; }
        .section-carrello { flex: 0 0 25%; overflow: hidden; display: flex; flex-direction: column; }
        .section-dati { flex: 0 0 10%; display: flex; align-items: center; justify-content: center; gap: 20px;}
        .section-bottoni { flex: 0 0 10%; display: flex; align-items: center; justify-content: center; gap: 20px; }

        /* Contenitori scrollabili */
        .scroll-box {
            flex: 1;
            width: 95%;
            margin: auto;
            overflow-y: auto;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 10px;
        }

        /* Tabella */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 18px;
        }

        /* Righe alte e senza padding verticale */
        table td, table th {
            border: 1px solid #444;
            min-height: 50px;
            padding: 0 10px;     /* niente padding verticale */
            vertical-align: middle;
        }

        /* Altezza reale SOLO per la colonna immagini */
        table td:nth-child(5) .color-select-display {
            height: 120px;   /* scegli tu */
        }


        /* Header sticky */
        thead th {
            position: sticky;
            top: 0;
            background: #eee;
            z-index: 5;
        }

        /* Immagini che riempiono la cella */
        table td img {
            height: 100%;
            width: auto;
            max-height: 100%;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        /* Prime colonne strette */
        #tabellaprodotti td:nth-child(1),
        #tabellaprodotti th:nth-child(1),
        #tabellaprodotti td:nth-child(2),
        #tabellaprodotti th:nth-child(2),
        #tabellaprodotti td:nth-child(3),
        #tabellaprodotti th:nth-child(3),
        #tabellaprodotti td:nth-child(4),
        #tabellaprodotti th:nth-child(4),
        #tabellaprodotti td:nth-child(6),
        #tabellaprodotti th:nth-child(6) {
            width: 80px;
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #tabellaCarrello td:nth-child(1),
        #tabellaCarrello th:nth-child(1),
        #tabellaCarrello td:nth-child(2),
        #tabellaCarrello th:nth-child(2) {
            width: 35%;
        }

        #tabellaCarrello td:nth-child(3),
        #tabellaCarrello th:nth-child(3),
        #tabellaCarrello td:nth-child(4),
        #tabellaCarrello th:nth-child(4),
        #tabellaCarrello td:nth-child(5),
        #tabellaCarrello th:nth-child(5) {
            width: 10%;
        }

        /* Selettore colorazioni */
        .color-select {
            width: 100%;
            height: 100%;
            cursor: pointer;
            user-select: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-select-display {
            width: 100%;
            height: 100%;
            padding: 0;
            border: 1px solid #444;
            border-radius: 6px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-select-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        /* Menu colorazioni */
        .color-select-options {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);   /* centra il menu */
            width: 50%;                  /* larghezza indipendente dalla colonna */
            overflow-y: auto;              /* scroll verticale */
            background: white;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 5px;
            display: none;
            flex-direction: column;        /* una sopra lâ€™altra */
            z-index: 1000;
            pointer-events: auto;
        }


        .color-select-options img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            margin-bottom: 5px;
        }

        .color-select-options img:hover {
            border-color: #4CAF50;
        }

        /* Carrello */
        #carrelloContainer input {
            width: 60px;
            font-size: 16px;
        }

        .btn-add {
            width: 100px;
            height: 100px;
            font-size: 40px;
            border-radius: 6px;
            cursor: pointer;
        }

        .section-bottoni button {
            width: 45%;
            height: 60px;
            font-size: 22px;
            border-radius: 8px;
        }

        .section-dati {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 10px 20px;
            font-size: 18px;
        }

        .section-dati label {
            font-weight: bold;
            width: 15%;
        }

        .section-dati input {
            width: 35%;
            padding: 8px 12px;
            font-size: 18px;
            border: 2px solid #444;
            border-radius: 6px;
        }

    </style>
</head>


<body>
    <div class="section-title">
        <h1>Seleziona un Prodotto</h1>
    </div>

    <div class="section-prodotti">
        <div class="scroll-box">
            <div id="tabellaProdotti"></div>
        </div>
    </div>

    <div class="section-carrello-title">
        <h2>Carrello</h2>
    </div>

    <div class="section-carrello">
        <div class="scroll-box" id="carrelloContainer">
            <p>Carrello vuoto</p>
        </div>
    </div>

    <div class="section-dati">
        <label for="campo1">Destinatario:</label>
        <input type="text" id="campo1" placeholder="Inserisci nome">

        <label for="dataVendita">Data vendita:</label> 
        <input type="date" id="dataVendita">
    </div>


    <div class="section-bottoni">
        <button>Conferma</button>
        <button onclick="window.location.href='page_vendite.html'">Annulla</button>
    </div>

    <script>
        window.onload = function () {
            caricaProdotti();

            const oggi = new Date().toISOString().split("T")[0];
            document.getElementById("dataVendita").value = oggi;
        };


        const client = supabase.createClient(
            "https://ixarnqyrsonhshkctcki.supabase.co",
            "sb_publishable_pGINBChZ1U3J4xUEvb0XtQ_pR7wc9eZ"
        );
        let tutteLeColorazioni = [];
        let strutturaProdotto = null;
        let carrello = [];

        async function caricaProdotti() {
            const { data: prodotti } =
                await client.from("prodotti").select("*").order("id", { ascending: true });

            const { data: colorazioni } =
                await client.from("colorazioni").select("id, prodottoid, percorsoimmagine");
            tutteLeColorazioni = colorazioni;
            strutturaProdotto = prodotti[0];
            document.getElementById("tabellaProdotti").innerHTML =
                generaTabellaProdotti(prodotti);
        }

        function generaTabellaProdotti(dati) {
            const colonneDaSaltare = ["id","sigla_prodotto", "sigla_tipologia", "sigla_tema","descrizione"];
            const colonne = Object.keys(dati[0]).filter(c => !colonneDaSaltare.includes(c));
            let html = '<table><tr>';
            for (const col of colonne) html += `<th>${col}</th>`;
            html += `<th>Colorazione</th><th>Aggiungi</th></tr>`;
                for (const riga of dati) {
                    html += `<tr data-id="${riga.id}">`;
                    for (const col of colonne) html += `<td>${riga[col]}</td>`;
                    const colori = tutteLeColorazioni.filter(c => c.prodottoid === riga.id);
                    let select = `
                        <div class="color-select" data-id="${riga.id}">
                            <div class="color-select-display">
                                <img id="color-preview-${riga.id}" 
                                    src="${colori[0]?.percorsoimmagine}" 
                                    data-idcolorazione="${colori[0]?.id}"
                                    onclick="toggleColorMenu('${riga.id}')">
                            </div>
                            <div class="color-select-options" id="color-options-${riga.id}">
                    `;
                    colori.forEach(c => {
                        select += `
                            <img 
                                src="${c.percorsoimmagine}" 
                                data-idcolorazione="${c.id}" 
                                onclick="selezionaColorazione('${riga.id}', '${c.percorsoimmagine}', '${c.id}')"
                            >
                        `;
                        console.log("GeneraTabella: ", c.id);
                    });
                    select += `
                            </div>
                        </div>
                    `;
                    html += `<td>${select}</td>`;
                    /*html += `<td><button onclick="aggiungiAlCarrello(${riga.id})">+</button></td>`;*/
                    html += `<td><button class="btn-add" onclick="aggiungiAlCarrello('${riga.id}')">+</button></td>`;
                    html += "</tr>";
                }
            html += "</table>";
            return html;
        }

        function toggleColorMenu(idProdotto) {
            const menu = document.getElementById(`color-options-${idProdotto}`);
            const riga = document.querySelector(`tr[data-id="${idProdotto}"]`);
            const isOpen = menu.style.display === "flex";

            // chiudi tutti i menu e resetta le righe
            document.querySelectorAll(".color-select-options").forEach(m => {
                m.style.display = "none";
                m.style.pointerEvents = "none";
            });
            document.querySelectorAll("tr").forEach(r => r.classList.remove("row-open"));

            if (!isOpen) {
                menu.style.display = "flex";
                menu.style.pointerEvents = "auto";
                riga.classList.add("row-open");   // questa riga sale sopra le altre
            }
        }

        function selezionaColorazione(idProdotto, imgPath, idColorazione) {
            console.log("Hai premuto il pulsante con:", idProdotto);
            console.log("Hai premuto il pulsante con:", imgPath);
            console.log("Hai premuto il pulsante con:", idColorazione);
            const preview = document.getElementById(`color-preview-${idProdotto}`);
            // aggiorna immagine
            preview.src = imgPath;
            // ðŸ”¥ salva l'id della colorazione selezionata
            preview.dataset.idcolorazione = idColorazione;
            // ðŸ”¥ salva anche sulla riga (piÃ¹ robusto)
            const riga = document.querySelector(`tr[data-id="${idProdotto}"]`);
            riga.dataset.colorazioneSelezionata = idColorazione;
            // chiudi menu
            const menu = document.getElementById(`color-options-${idProdotto}`);
            menu.style.display = "none";
            menu.style.pointerEvents = "none";
        }

        function aggiungiAlCarrello(idProdotto) {
            let html = `
                <table style="width:100%">
                    <tr>
                        <th>ID</th>
                        <th>Immagine</th>
                        <th>Prezzo</th>
                        <th>Q.tÃ </th>
                        <th></th>
                    </tr>
            `;
            const riga = document.querySelector(`tr[data-id="${idProdotto}"]`);
            const celle = riga.querySelectorAll("td");
            const nome = celle[1].innerText;
            const prezzo = parseFloat(celle[3].innerText);
            const preview = document.getElementById(`color-preview-${idProdotto}`);
            const colorazione = preview.src;
            const idColorazione = preview.dataset.idcolorazione;
            if (!idColorazione) {
                alert("Seleziona una colorazione prima di aggiungere al carrello.");
                return;
            }
            const esistente = carrello.find(x => x.id === idProdotto && x.idColorazione === idColorazione);
            if (esistente) {
                esistente.quantita++;
            } else {
                carrello.push({
                    id: idProdotto,
                    idColorazione: idColorazione,
                    nome,
                    colorazione,
                    prezzo,
                    quantita: 1
                });
            }
            aggiornaCarrello();
        }

        function aggiornaCarrello() {
            if (carrello.length === 0) {
                document.getElementById("carrelloContainer").innerHTML = "<p>Carrello vuoto</p>";
                return;
            }

            let html = "<table><tr><th>Colorazione ID</th><th>Immagine</th><th>Prezzo</th><th>Q.tÃ </th><th></th></tr>";

            carrello.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item.idColorazione}</td>
                        <td><img src="${item.colorazione}" style="width:100px;height:70px;object-fit:contain;border-radius:6px;"></td>
                        <td>${item.prezzo.toFixed(2)}</td>
                        <td>
                            <input type="number" min="1" value="${item.quantita}" 
                                onchange="cambiaQuantita(${index}, this.value)">
                        </td>
                        <td><button onclick="rimuoviDalCarrello(${index})">X</button></td>
                    </tr>
                `;
            });

            html += "</table>";

            document.getElementById("carrelloContainer").innerHTML = html;
        }

        function cambiaQuantita(index, nuovaQta) {
            carrello[index].quantita = parseInt(nuovaQta);
            aggiornaCarrello();
        }

        function rimuoviDalCarrello(index) {
            carrello.splice(index, 1);
            aggiornaCarrello();
        }

        document.addEventListener("click", function (e) {
            const tuttiMenu = document.querySelectorAll(".color-select-options");

            tuttiMenu.forEach(menu => {
                if (!menu.contains(e.target) && !menu.previousElementSibling.contains(e.target)) {
                    menu.style.display = "none";
                    menu.style.pointerEvents = "none";
                }
            });
        });

        window.onload = caricaProdotti;
    </script>

</body>
</html>
